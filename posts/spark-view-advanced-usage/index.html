<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Spark View Advanced Usage">
<meta itemprop="description" content="View in spark is a powerful data layer, on which you can apply flexciable logics and control data visibility as well as orgnaize different sources together.
I made lots of practice on view, it is worth to summarize the notice points on view advance usage. Before that, I did mutiple testing to make sure it is as correct as possible.
Scope View not only could be a intermedia temporary code block, but also can be built permanently based on user requirements."><meta itemprop="datePublished" content="2023-06-05T09:59:23+08:00" />
<meta itemprop="dateModified" content="2023-06-05T09:59:23+08:00" />
<meta itemprop="wordCount" content="864">
<meta itemprop="keywords" content="spark," /><meta property="og:title" content="Spark View Advanced Usage" />
<meta property="og:description" content="View in spark is a powerful data layer, on which you can apply flexciable logics and control data visibility as well as orgnaize different sources together.
I made lots of practice on view, it is worth to summarize the notice points on view advance usage. Before that, I did mutiple testing to make sure it is as correct as possible.
Scope View not only could be a intermedia temporary code block, but also can be built permanently based on user requirements." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://func.fun/posts/spark-view-advanced-usage/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-05T09:59:23+08:00" />
<meta property="article:modified_time" content="2023-06-05T09:59:23+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spark View Advanced Usage"/>
<meta name="twitter:description" content="View in spark is a powerful data layer, on which you can apply flexciable logics and control data visibility as well as orgnaize different sources together.
I made lots of practice on view, it is worth to summarize the notice points on view advance usage. Before that, I did mutiple testing to make sure it is as correct as possible.
Scope View not only could be a intermedia temporary code block, but also can be built permanently based on user requirements."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Spark View Advanced Usage</title>
	<link rel="stylesheet" href="https://func.fun/css/style.min.037b6ee8f8c1baab6a3d0a9da11c3ff18a7552471f16c59fd98538d5ce99208b.css" integrity="sha256-A3tu6PjBuqtqPQqdoRw/8Yp1UkcfFsWf2YU41c6ZIIs=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://func.fun">funcfun</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://func.fun/about">About</a>
				<a href="https://func.fun/posts/">Posts</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://github.com/Thunsis" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://func.fun/about">About</a></li>
			<li><a href="https://func.fun/posts/">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jun 5, 2023</span></div>
				<h1>Spark View Advanced Usage</h1>
			</header>
			<div class="content">
				<p>View in spark is a powerful data layer, on which you can apply flexciable logics and control data visibility as well as orgnaize different sources together.</p>
<p>I made lots of practice on view, it is worth to summarize the notice points on view advance usage. Before that, I did mutiple testing to make sure it is as correct as possible.</p>
<h2 id="scope">Scope<a href="#scope" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>View not only could be a intermedia temporary code block, but also can be built permanently based on user requirements.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- temporary view only effect in current session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">create</span><span class="w"> </span><span class="p">[</span><span class="k">or</span><span class="w"> </span><span class="k">replace</span><span class="p">]</span><span class="w"> </span><span class="k">temporary</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">temp_v</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="p">...;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- permanent global view 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">create</span><span class="w"> </span><span class="p">[</span><span class="k">or</span><span class="w"> </span><span class="k">replace</span><span class="p">]</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">p_cm_v</span><span class="p">.</span><span class="n">global_v</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="p">...;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- drop permanent view
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">drop</span><span class="w"> </span><span class="p">[</span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="p">]</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">p_cm_v</span><span class="p">.</span><span class="n">global_v</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h2 id="column">Column<a href="#column" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>View just like a table having its own structure including name and column even isNullable option. Taking below ddl as example to show how the columns name and type are generated. So that we know how to keep them unchanged when rebuilding the view.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">replace</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">p_cm_v</span><span class="p">.</span><span class="n">global_v</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">name_1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">age_1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">sex_1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">birthday_1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">name_2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">age_2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">sex_2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">birthday_2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">table_a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">union</span><span class="w"> </span><span class="k">all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">name_3</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">age_3</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">sex_3</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">birthday_3</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">table_b</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="name">Name<a href="#name" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ol>
<li>The name defining priority is based on position:  *_1 &gt; *_2 &gt; *_3 (event though name is undefined).</li>
<li>If name is undefined, then name is sql state content, for example:</li>
</ol>
<table>
<thead>
<tr>
<th>col_name</th>
<th>data_type</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>CASE WHEN (1 = 1) THEN 1 ELSE 0 END</td>
<td>int</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>col_name</th>
<th>data_type</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>CAST(1 AS INT)</td>
<td>int</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<h3 id="type">Type<a href="#type" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ol>
<li>Briefly, the type is the combination of *_2 and *_3 if it is valid combination, otherwise will throw error.</li>
</ol>
<p>In detail:</p>
<p>In Spark 3.0, when inserting values ​​into table columns with different data types, type casting is performed according to the ANSI SQL standard. Some unreasonable type conversions (such as string to int and double to boolean) are not allowed.</p>
<p>In Spark 2.4 and earlier, type conversions are allowed during table inserts as long as the type conversions are valid casts. When inserting an out-of-range value into an integer field, the low-order bits of the value are inserted (same as Java/Scala numeric type casts). For example, if 257 is inserted into a field of type Byte, the result is 1. This behavior is controlled by the option spark.sql.storeAssignmentPolicy, which defaults to &ldquo;ANSI&rdquo;. Setting this option to &ldquo;Legacy&rdquo; restores the previous behavior.</p>
<p><a href="https://learn.microsoft.com/zh-cn/azure/databricks/release-notes/runtime/7.x-migration#sql-datasets-and-dataframe">https://learn.microsoft.com/zh-cn/azure/databricks/release-notes/runtime/7.x-migration#sql-datasets-and-dataframe</a></p>
<p>When <code>spark.sql.storeAssignmentPolicy</code> is set to <code>ANSI</code>(which is the default value since Spark 3.0), Spark SQL complies with the ANSI store assignment rules on table insertions. The valid combinations of source and target data type in table insertions are given by the following table.</p>
<table>
<thead>
<tr>
<th><strong>SourceTarget</strong></th>
<th><strong>Numeric</strong></th>
<th><strong>String</strong></th>
<th><strong>Date</strong></th>
<th><strong>Timestamp</strong></th>
<th><strong>Interval</strong></th>
<th><strong>Boolean</strong></th>
<th><strong>Binary</strong></th>
<th><strong>Array</strong></th>
<th><strong>Map</strong></th>
<th><strong>Struct</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Numeric</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>String</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Date</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Timestamp</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Interval</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Boolean</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Binary</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Array</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y*</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td>Map</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y*</td>
<td>N</td>
</tr>
<tr>
<td>Struct</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y*</td>
</tr>
</tbody>
</table>
<p><a href="https://learn.microsoft.com/en-us/azure/databricks/sql/language-manual/sql-ref-ansi-compliance#store-assignment">https://learn.microsoft.com/en-us/azure/databricks/sql/language-manual/sql-ref-ansi-compliance#store-assignment</a></p>
<h3 id="isnullable">isNullable<a href="#isnullable" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ol>
<li>Hardly be set in Spark-SQL, but when you define a column by hard code, it will be set as true automatically.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">as</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">map</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="n">info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="p">...;</span><span class="w">
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>col_name</th>
<th>data_type</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>age</td>
<td>int not null</td>
<td>null</td>
</tr>
<tr>
<td>info</td>
<td>map not null</td>
<td>null</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>It is an optional setting in Scala API.</li>
</ol>
<h2 id="performance-tuning-case">Performance Tuning Case<a href="#performance-tuning-case" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>View is not same as table. The flexciable logic also would bring performance issue when being queried. Where is logic, where could be optimized.</p>
<p>The initial version has performance issue when being queried in spark 2.3 because it envolved in <em>Broadcast Nested Loop Join.</em></p>
<p>After analysing, we can join the full table and then filter the data.</p>
<p>Before:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">replace</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">access_views</span><span class="p">.</span><span class="n">mh_event_ep</span><span class="w"> </span><span class="k">as</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">case</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">pa_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">and</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">esp_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Nespresso&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">pa_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;PA&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">esp_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Espresso&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">other_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="n">email_type</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">access_views</span><span class="p">.</span><span class="n">mh_event</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">join</span><span class="w"> </span><span class="n">prs_restricted_v</span><span class="p">.</span><span class="n">msg_type_lkp</span><span class="w"> </span><span class="n">lkp</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">sent_dt</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">start_dt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">end_dt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">actn_dt</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="k">current_date</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="k">current_date</span><span class="w"> </span><span class="c1">-- partition key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">sent_dt</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="k">current_date</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="k">current_date</span><span class="w"> </span><span class="c1">-- bussiness requested;
</span></span></span></code></pre></div><p>After:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">replace</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">access_views</span><span class="p">.</span><span class="n">mh_event_ep</span><span class="w"> </span><span class="k">as</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">case</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">pa_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">and</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">esp_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Nespresso&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">pa_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;PA&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">esp_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Espresso&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="k">size</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">array_intersect</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">canvas_msg_ids</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">other_msg_list</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">end</span><span class="w"> </span><span class="n">email_type</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">access_views</span><span class="p">.</span><span class="n">mh_event</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">join</span><span class="w"> </span><span class="n">prs_restricted_v</span><span class="p">.</span><span class="n">msg_type_lkp</span><span class="w"> </span><span class="n">lkp</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">end_dt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="k">current_date</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">actn_dt</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="k">current_date</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="k">current_date</span><span class="w"> </span><span class="c1">-- partition key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">sent_dt</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="k">current_date</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="k">current_date</span><span class="w"> </span><span class="c1">-- bussiness requested
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">sent_dt</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">start_dt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">and</span><span class="w"> </span><span class="n">lkp</span><span class="p">.</span><span class="n">end_dt</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://func.fun/tags/spark">spark</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>864 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2023-06-05 09:59 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="prev-post" href="https://func.fun/posts/click-rate-drops-investigate/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Click Rate Drops Investigate</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2023 <a href="https://func.fun">Xuan HE</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://func.fun/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://func.fun/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js" integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin="anonymous"></script>
	

</body>

</html>
